---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Image } from "astro:assets";
import withBase from "../../utils/withBase";

const dvd = (await getCollection('dvd')).toSorted((a, b) => a.data.order - b.data.order);

const baseImagePath = '/src/assets/images/dvd/';
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/dvd/*.{jpeg,jpg,png,gif}');

// Resolve glob loaders into actual metadata objects so we can use them synchronously in the template.
const resolvedImages: Record<string, ImageMetadata> = {};
for (const key of Object.keys(images)) {
    try {
        const mod = await images[key]();
        resolvedImages[key] = mod?.default ?? mod;
    } catch (err) {
        // ignore individual import errors; the template will throw a clearer error if missing
    }
}
---
<Layout>
	<h2>DVD de La Rete</h2>
	<p>
		I DVD, realizzati da <strong>La Rete</strong> con il coordinamento di <strong>Maurizio Roccato</strong>,
		possono essere richiesti scrivendo a <a href="mailto:grandevercelli@gmail.com">grandevercelli@gmail.com</a>.
	</p>
	<div class="dvd-container">
		{dvd.map((d) => {
			const imagePath = baseImagePath + d.data.image;
            if (!resolvedImages[imagePath]) {
                throw new Error(`"${imagePath}" does not exist in glob: "/src/assets/images/dvd/*.{jpeg,jpg,png,gif}"`);
            }
			
			return (
			<a href={withBase(`/dvd/${d.id}`)}>
				<section class="dvd card">
					<header>
						<h3>{d.data.title}</h3>
					</header>
					<div class="picture">
						<Image src={resolvedImages[imagePath]} alt={d.data.title} />
					</div>
				</section>
			</a>
		)})}
	</div>
</Layout>

<style>
	.dvd-container {
		display: grid;
		grid-template-columns: 1fr;
		gap: 2rem;

		@media (min-width: 600px) {
			grid-template-columns: 1fr 1fr;
		}
	}

	.dvd {
		display: grid;
		grid-template: "picture" auto "header" auto / auto;
		gap: 1rem;

		.picture {
			grid-area: picture;

			img {
				width: 100%;
				height: auto;
				border-radius: 0.25rem;
			}
		}

		header {
			grid-area: header;

			h3 {
				margin: 0;
			}
		}
	}
</style>
